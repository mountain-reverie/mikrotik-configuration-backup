name: Pull Request CI

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: write
  security-events: write
  packages: read
  actions: read
  pull-requests: write
  pages: write
  id-token: write

jobs:
  ci:
    name: Run CI
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  claude-fix:
    name: Claude Auto-fix
    runs-on: ubuntu-latest
    needs: ci
    if: |
      failure() &&
      github.event_name == 'pull_request' &&
      github.actor == 'dependabot[bot]'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check for previous Claude attempts
        id: check_attempts
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const claudeComments = comments.data.filter(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('Claude Code attempted')
            );

            if (claudeComments.length > 0) {
              core.setOutput('skip', 'true');
              console.log('Claude has already attempted to fix this PR');
            } else {
              core.setOutput('skip', 'false');
            }

      - name: Checkout PR branch
        if: steps.check_attempts.outputs.skip != 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        if: steps.check_attempts.outputs.skip != 'true'
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Install tools
        if: steps.check_attempts.outputs.skip != 'true'
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest
          go install golang.org/x/tools/gopls@latest

      - name: Run Claude Code
        if: steps.check_attempts.outputs.skip != 'true'
        uses: anthropics/anthropic-code-action@0630ef383a451c46ccac86eb86ee7641e99c4c9a # v1.0.0
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            This Dependabot PR is failing CI. Please:
            1. Run `go build ./...` to check for build errors
            2. Run `golangci-lint run` to check for linting issues
            3. Run `go test ./...` to check for test failures
            4. Fix any issues found
            5. Ensure all commands pass successfully

            Focus on:
            - Fixing breaking API changes
            - Updating deprecated function calls
            - Resolving import issues
            - Fixing test failures

          tools: |
            Edit
            Read
            Bash

      - name: Check for changes
        if: steps.check_attempts.outputs.skip != 'true'
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "fix: claude code automated fixes for dependabot update"
          git push

      - name: Comment on PR
        if: always() && steps.check_attempts.outputs.skip != 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const hasChanges = '${{ steps.check_changes.outputs.has_changes }}' === 'true';
            const body = hasChanges
              ? 'ðŸ¤– Claude Code attempted to fix the failing CI and committed changes.'
              : 'ðŸ¤– Claude Code attempted to fix the failing CI but found no changes to make.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]' && github.repository == 'mountain-reverie/mikrotik-configuration-backup'
    steps:
      - name: Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@08eff52bf64351f401fb50d4972fa95b9f2c2d1b

      - name: Enable auto-merge for Dependabot PRs
        if: ${{ steps.dependabot-metadata.outputs.maintainer-changes && (steps.dependabot-metadata.outputs.package-ecosystem == 'go_modules' || steps.dependabot-metadata.outputs.package-ecosystem == 'github_actions') }}
        run: gh pr merge --auto --merge "${{github.event.pull_request.html_url}}"
        env:
          GH_TOKEN: ${{secrets.DEPENDABOT_PAT}}

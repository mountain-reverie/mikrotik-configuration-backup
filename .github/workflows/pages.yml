name: Deploy GitHub Pages

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'Name of the artifact to deploy'
        required: false
        type: string
        default: 'github-pages'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-pages:
    name: Build GitHub Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Install tools
        run: |
          go install gotest.tools/gotestsum@latest
          go install golang.org/x/perf/cmd/benchstat@latest

      - name: Create pages directory
        run: mkdir -p _site

      - name: Run tests with coverage
        run: |
          gotestsum --junitfile _site/junit.xml \
            --format testname \
            -- -v -race -coverprofile=_site/coverage.out -covermode=atomic ./...

      - name: Generate coverage HTML
        run: |
          go tool cover -html=_site/coverage.out -o _site/coverage.html

      - name: Generate coverage badge
        run: |
          coverage=$(go tool cover -func=_site/coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          color="red"
          if (( $(echo "$coverage >= 80" | bc -l) )); then
            color="green"
          elif (( $(echo "$coverage >= 60" | bc -l) )); then
            color="yellow"
          elif (( $(echo "$coverage >= 40" | bc -l) )); then
            color="orange"
          fi

          cat > _site/coverage-badge.svg << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="120" height="20">
            <linearGradient id="b" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <mask id="a">
              <rect width="120" height="20" rx="3" fill="#fff"/>
            </mask>
            <g mask="url(#a)">
              <path fill="#555" d="M0 0h63v20H0z"/>
              <path fill="$color" d="M63 0h57v20H63z"/>
              <path fill="url(#b)" d="M0 0h120v20H0z"/>
            </g>
            <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="31.5" y="15" fill="#010101" fill-opacity=".3">coverage</text>
              <text x="31.5" y="14">coverage</text>
              <text x="90.5" y="15" fill="#010101" fill-opacity=".3">${coverage}%</text>
              <text x="90.5" y="14">${coverage}%</text>
            </g>
          </svg>
          EOF

      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -run=^$ ./... > _site/benchmarks.txt 2>&1 || true

      - name: Download previous benchmarks
        continue-on-error: true
        run: |
          # Try to download previous benchmark results from GitHub Pages
          curl -f -o previous-benchmarks.txt \
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/benchmarks.txt || true

      - name: Compare benchmarks
        if: hashFiles('previous-benchmarks.txt') != ''
        run: |
          benchstat previous-benchmarks.txt _site/benchmarks.txt > _site/benchmark-comparison.txt || true

      - name: Generate index.html
        run: |
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>MikroTik Configuration Backup - Documentation</title>
            <style>
              :root {
                --primary-color: #0366d6;
                --bg-color: #ffffff;
                --text-color: #24292e;
                --border-color: #e1e4e8;
                --code-bg: #f6f8fa;
              }
              @media (prefers-color-scheme: dark) {
                :root {
                  --bg-color: #0d1117;
                  --text-color: #c9d1d9;
                  --border-color: #30363d;
                  --code-bg: #161b22;
                }
              }
              * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
              }
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                line-height: 1.6;
                color: var(--text-color);
                background-color: var(--bg-color);
                padding: 2rem;
              }
              .container {
                max-width: 1200px;
                margin: 0 auto;
              }
              header {
                text-align: center;
                padding: 2rem 0;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 2rem;
              }
              h1 {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
              }
              .subtitle {
                color: #586069;
                font-size: 1.2rem;
              }
              .badge {
                display: inline-block;
                margin: 0.5rem 0.25rem;
              }
              .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 2rem;
                margin: 2rem 0;
              }
              .card {
                background: var(--code-bg);
                border: 1px solid var(--border-color);
                border-radius: 6px;
                padding: 1.5rem;
                transition: transform 0.2s;
              }
              .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
              }
              .card h2 {
                margin-bottom: 1rem;
                color: var(--primary-color);
              }
              .card p {
                margin-bottom: 1rem;
                color: #586069;
              }
              .btn {
                display: inline-block;
                padding: 0.5rem 1rem;
                background: var(--primary-color);
                color: white;
                text-decoration: none;
                border-radius: 6px;
                transition: background 0.2s;
              }
              .btn:hover {
                background: #0256c7;
              }
              footer {
                text-align: center;
                padding: 2rem 0;
                border-top: 1px solid var(--border-color);
                margin-top: 2rem;
                color: #586069;
              }
              .stats {
                display: flex;
                justify-content: space-around;
                flex-wrap: wrap;
                margin: 2rem 0;
                padding: 1rem;
                background: var(--code-bg);
                border-radius: 6px;
              }
              .stat {
                text-align: center;
                padding: 1rem;
              }
              .stat-value {
                font-size: 2rem;
                font-weight: bold;
                color: var(--primary-color);
              }
              .stat-label {
                color: #586069;
                margin-top: 0.5rem;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <h1>MikroTik Configuration Backup</h1>
                <p class="subtitle">A robust CLI tool to backup MikroTik RouterOS configurations</p>
                <div class="badges">
                  <a href="https://github.com/mountain-reverie/mikrotik-configuration-backup/actions" class="badge">
                    <img src="https://github.com/mountain-reverie/mikrotik-configuration-backup/actions/workflows/ci.yml/badge.svg" alt="CI">
                  </a>
                  <a href="https://goreportcard.com/report/github.com/mountain-reverie/mikrotik-configuration-backup" class="badge">
                    <img src="https://goreportcard.com/badge/github.com/mountain-reverie/mikrotik-configuration-backup" alt="Go Report Card">
                  </a>
                  <a href="coverage.html" class="badge">
                    <img src="coverage-badge.svg" alt="Coverage">
                  </a>
                  <a href="https://github.com/mountain-reverie/mikrotik-configuration-backup/releases" class="badge">
                    <img src="https://img.shields.io/github/v/release/mountain-reverie/mikrotik-configuration-backup" alt="Release">
                  </a>
                </div>
              </header>

              <main>
                <div class="stats">
                  <div class="stat">
                    <div class="stat-value" id="test-count">-</div>
                    <div class="stat-label">Tests Passing</div>
                  </div>
                  <div class="stat">
                    <div class="stat-value" id="coverage">-</div>
                    <div class="stat-label">Code Coverage</div>
                  </div>
                  <div class="stat">
                    <div class="stat-value" id="build-time">-</div>
                    <div class="stat-label">Last Build</div>
                  </div>
                </div>

                <div class="grid">
                  <div class="card">
                    <h2>üìä Test Coverage</h2>
                    <p>View detailed code coverage report showing which parts of the codebase are tested.</p>
                    <a href="coverage.html" class="btn">View Coverage Report</a>
                  </div>

                  <div class="card">
                    <h2>‚ö° Benchmarks</h2>
                    <p>Performance benchmark results and comparisons across versions.</p>
                    <a href="benchmarks.txt" class="btn">View Benchmarks</a>
                  </div>

                  <div class="card">
                    <h2>üìà Benchmark Comparison</h2>
                    <p>Statistical comparison of current vs previous benchmark results.</p>
                    <a href="benchmark-comparison.txt" class="btn">View Comparison</a>
                  </div>

                  <div class="card">
                    <h2>üìã Test Results</h2>
                    <p>JUnit XML test results for integration with CI/CD tools.</p>
                    <a href="junit.xml" class="btn">View Test Results</a>
                  </div>

                  <div class="card">
                    <h2>üìñ Documentation</h2>
                    <p>Read the full project documentation on GitHub.</p>
                    <a href="https://github.com/mountain-reverie/mikrotik-configuration-backup" class="btn">View on GitHub</a>
                  </div>

                  <div class="card">
                    <h2>üöÄ Releases</h2>
                    <p>Download the latest release binaries for your platform.</p>
                    <a href="https://github.com/mountain-reverie/mikrotik-configuration-backup/releases" class="btn">View Releases</a>
                  </div>
                </div>
              </main>

              <footer>
                <p>Generated by GitHub Actions ‚Ä¢ Last updated: <span id="timestamp"></span></p>
                <p>Made with ‚ù§Ô∏è for the MikroTik community</p>
              </footer>
            </div>

            <script>
              // Set timestamp
              document.getElementById('timestamp').textContent = new Date().toLocaleString();

              // Load coverage data
              fetch('coverage.out')
                .then(response => response.text())
                .then(data => {
                  const lines = data.split('\n');
                  const totalLine = lines[lines.length - 2] || '';
                  const match = totalLine.match(/(\d+\.\d+)%/);
                  if (match) {
                    document.getElementById('coverage').textContent = match[1] + '%';
                  }
                })
                .catch(() => {});

              // Load test count from JUnit XML
              fetch('junit.xml')
                .then(response => response.text())
                .then(data => {
                  const parser = new DOMParser();
                  const xml = parser.parseFromString(data, 'text/xml');
                  const testsuites = xml.getElementsByTagName('testsuite');
                  let total = 0;
                  for (let suite of testsuites) {
                    total += parseInt(suite.getAttribute('tests') || 0);
                  }
                  document.getElementById('test-count').textContent = total;
                })
                .catch(() => {});

              // Set build time
              document.getElementById('build-time').textContent = 'Just now';
            </script>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: '_site'
          name: ${{ inputs.artifact-name }}

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
        with:
          artifact_name: ${{ inputs.artifact-name }}
